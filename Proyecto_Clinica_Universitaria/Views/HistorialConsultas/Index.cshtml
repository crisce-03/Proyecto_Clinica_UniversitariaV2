@model List<Proyecto_Clinica_Universitaria.Models.ConsultaVistaModel>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor Accessor
@{
    var permisoActual = Accessor.HttpContext?.Session.GetString("Permiso") ?? "Lectura";
    bool puedeEditar =
        string.Equals(permisoActual, "Edicion", StringComparison.OrdinalIgnoreCase) ||
        string.Equals(permisoActual, "Administracion", StringComparison.OrdinalIgnoreCase);
}

@section Styles {
    <link href="~/css/historialConsultasStyle.css" rel="stylesheet" />
}

<main class="p-4">
    <!-- Token antiforgery oculto -->
    <form id="formAntiForgery" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <!-- Aviso de permisos si no puede editar -->
    @if (!puedeEditar)
    {
        <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                Estás en modo <strong>@permisoActual</strong>. No puedes <strong>crear, editar ni eliminar</strong> consultas.
            </div>
        </div>
    }

    <!-- Top form -->
    <div class="card-box">
        <div class="row g-3 align-items-center">
            <div class="row">
                <!-- Historia Clínica -->
                <div class="shadow-lg p-3 col-md-4 mb-3 history-input rounded">
                    <i class="bi bi-journal-medical icon"></i>
                    <div class="text-end">1</div>
                    <hr class="my-2">
                    <div class="text-start">ESPECIALIDAD</div>
                </div>
            </div>

            <div class="row">
                <!-- Buscar -->
                <div class="col-md-5">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar..." />
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="card-box table-responsive">
            <table class="table table-striped table-hover" id="consultasTable">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Cédula</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Temperatura</th>
                        <th>Pulso</th>
                        <th>Peso</th>
                        <th>Presión</th>
                        <th>SWAT O2</th>
                        <th>Médico</th>
                        <th>Medicamento</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var consulta in Model)
                        {
                            <tr data-id="@consulta.Codigo">
                                <td>@consulta.Fecha.ToString("dd/MM/yyyy")</td>
                                <td>@consulta.Cedula</td>
                                <td>@consulta.Nombre</td>
                                <td>@consulta.Apellido</td>
                                <td>@consulta.Temperatura</td>
                                <td>@consulta.Pulso</td>
                                <td>@consulta.Peso</td>
                                <td>@consulta.Presion</td>
                                <td>@consulta.SwatO2</td>
                                <td>@consulta.MedicoNombre</td>
                                <td>@consulta.MedicamentoNombre</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="11" class="text-center">No hay consultas registradas.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Barra de acciones: solo habilitada si puedeEditar -->
<section class="d-flex justify-content-center gap-3 mt-4 p-3 bg-white rounded">
    @if (puedeEditar)
    {
        <a asp-controller="Consultas" asp-action="Index"
           class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2"
           style="background-color:#880C09;">
            <i class="bi bi-plus-circle"></i>
            <span class="d-none d-md-inline">Nuevo</span>
        </a>
        <button id="btnEliminar"
                class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2"
                style="background-color:#880C09;" disabled>
            <i class="bi bi-trash"></i>
            <span class="d-none d-md-inline">Eliminar</span>
        </button>
        <button id="btnEditar"
                class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2"
                style="background-color:#880C09;" disabled>
            <i class="bi bi-pencil-square"></i>
            <span class="d-none d-md-inline">Editar</span>
        </button>
    }
    else
    {
        <!-- Versión deshabilitada visualmente -->
        <button class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2"
                style="background-color:#880C09; opacity:.6;" disabled title="No tienes permiso para crear">
            <i class="bi bi-plus-circle"></i>
            <span class="d-none d-md-inline">Nuevo</span>
        </button>
        <button id="btnEliminar" class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2"
                style="background-color:#880C09; opacity:.6;" disabled title="No tienes permiso para eliminar">
            <i class="bi bi-trash"></i>
            <span class="d-none d-md-inline">Eliminar</span>
        </button>
        <button id="btnEditar" class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2"
                style="background-color:#880C09; opacity:.6;" disabled title="No tienes permiso para editar">
            <i class="bi bi-pencil-square"></i>
            <span class="d-none d-md-inline">Editar</span>
        </button>

        <div class="text-muted small text-center w-100 mt-2">
            Acciones deshabilitadas por permiso: <strong>@permisoActual</strong>.
        </div>
    }
</section>

<!-- Modal de confirmación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow-lg border-0">
            <div class="modal-header bg-danger text-white rounded-top-3">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5 mb-0">¿Estás seguro que deseas eliminar esta consulta?</p>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" id="confirmDelete" class="btn btn-danger px-4">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const PUEDE_EDITAR = @puedeEditar.ToString().ToLower(); // true/false literal

        let selectedRow = null;
        let consultaId = null;

        const btnEliminar = document.getElementById('btnEliminar');
        const btnEditar   = document.getElementById('btnEditar');

        // Selección de filas (si no puede editar, solo resaltamos pero no habilitamos botones)
        document.querySelectorAll('#consultasTable tbody tr').forEach(row => {
            row.addEventListener('click', () => {
                if (selectedRow) selectedRow.classList.remove('table-active');

                if (selectedRow === row) {
                    selectedRow = null;
                    if (btnEliminar) btnEliminar.disabled = true;
                    if (btnEditar)   btnEditar.disabled = true;
                    return;
                }

                selectedRow = row;
                row.classList.add('table-active');

                if (PUEDE_EDITAR) {
                    if (btnEliminar) btnEliminar.disabled = false;
                    if (btnEditar)   btnEditar.disabled = false;
                } else {
                    if (btnEliminar) btnEliminar.disabled = true;
                    if (btnEditar)   btnEditar.disabled = true;
                }
            });
        });

        // Eliminar (solo si tiene permiso)
        btnEliminar?.addEventListener('click', () => {
            if (!PUEDE_EDITAR) { alert("No tienes permiso para eliminar consultas."); return; }
            if (!selectedRow) return;

            consultaId = selectedRow.getAttribute('data-id');
            let deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        });

        document.getElementById('confirmDelete').addEventListener('click', () => {
            if (!PUEDE_EDITAR) { alert("No tienes permiso para eliminar consultas."); return; }
            const token = document.querySelector('#formAntiForgery input[name="__RequestVerificationToken"]').value;

            fetch('/Consultas/Eliminar', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    '__RequestVerificationToken': token,
                    'codigo': consultaId
                })
            })
            .then(response => {
                if (response.ok) {
                    selectedRow?.remove();
                    selectedRow = null;
                    if (btnEliminar) btnEliminar.disabled = true;
                    if (btnEditar)   btnEditar.disabled = true;
                } else {
                    alert("Error al eliminar la consulta.");
                }
            })
            .catch(() => alert("Error de conexión con el servidor."))
            .finally(() => {
                let deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                deleteModal?.hide();
            });
        });

        // Editar (solo si tiene permiso)
        btnEditar?.addEventListener('click', () => {
            if (!PUEDE_EDITAR) { alert("No tienes permiso para editar consultas."); return; }
            if (!selectedRow) return;
            const id = selectedRow.getAttribute('data-id');
            window.location.href = `/Consultas/Index?id=${id}`;
        });
    </script>
}
